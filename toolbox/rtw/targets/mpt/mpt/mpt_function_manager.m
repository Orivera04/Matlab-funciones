function mpt_function_manager(modelName,mptGUIHandle)
%MPT_FUNCTION_MANAGER creates the function manager GUI.
%
%   MPT_FUNCTION_MANAGER(MODELNAME, MPTGUIHANDLE)
%         Create function manager dialog.
%
%   INPUT:
%         modelName:     Name of model.
%         mptGUIHandle:  Handle of MPT Main GUI

%   Steve Toeppe
%   Copyright 2002 The MathWorks, Inc.
%   $Revision: 1.6 $
%   $Date: 2002/07/29 02:25:05 $

% Revision History
%     Version 1.6    Steve Toeppe
% Add refresh of internal header file information. Add in model name and file
% select value to fm structure 

blockPath = find_mpt_block(modelName);
fm = get(mptGUIHandle,'UserData');
if isfield(fm,'hFig') == 1
    try
        x=get(fm.hFig,'Tag');
        mpt_fm_callback('RefreshFile', fm);
        figure(fm.hFig);
        return
    catch
        fail=1;
    end
end
fm.blockPath = blockPath;
fm.modelName = modelName;
fm.fileSelValue = 1;
bx=1;
by=1;
w = 200;
% h = 21;
% m = 3;  %margin
% global fm;
fm.modelName=modelName;
fm.bx=1;
fm.by=1;
fm.w1 = 140;
fm.w2 = 140;
fm.w3 = 130;
fm.w4 = 140;
fm.h = 18;
fm.lh =240;
fm.hm = 21;  %heigth with margin
fm.m = 3;    %margin
fm.sPos = get(0,'ScreenSize');
fp.fx = fm.sPos(3)-700;
if fp.fx < 1
    fp.fx = 1;
end
fp.fy = 200;
fm.hFig = figure('MenuBar', 'none',...
    'Name',['MPT Function Manager : ',modelName],...
    'Color',                              get(0,'FactoryUicontrolBack'), ...
    'Units',                              'pixels', ...
    'Resize',                             'on', ...
    'NumberTitle',                        'off', ...
    'ResizeFcn',['mpt_fm_callback(''fm_resize'',''','',''')'],...
    'Position',[fp.fx,fp.fy,fm.w1+fm.w2+fm.w3+fm.w4+6*fm.m,fm.lh+2*fm.h],...
    'DefaultUicontrolUnits',              'pixels');%, ... 

%'ResizeFcn','aw_callback(''fig'',''ResizeFcn'')'); 
fp = get_file_package(modelName);
fileList=[];
functionList=[];
for i=1:length(fp.fileFunList)
    fileList{i}=fp.fileFunList{i}.name;
end
for i=1:length(fp.fileFunList{1}.function)
    functionList{i}=fp.fileFunList{1}.function{i}.name;
end
fm.fileList = fileList;
fm.functionList = functionList;
fm.fileFunList=fp.fileFunList;
%  "File Name" Title over File List Box
fm.th1 = uicontrol('Style','Text',...
    'Position',[fm.bx,fm.lh+1,fm.w1,fm.h],...
    'HorizontalAlignment','Left',...
    'String','File Name');

%  File List Box
fm.lh1 = uicontrol('Style',   'List',...
    'String',fileList,...
    'Enable','on',...
    'Callback',['mpt_fm_callback(''file_select'',''','',''')'],...
    'Position',[fm.bx,fm.by,fm.w1,fm.lh]);

%  "Function Name" Title over File List Box
fm.th2 = uicontrol('Style','Text',...
    'Position',[fm.bx+fm.w1,fm.lh+1,fm.w2,fm.h],...
    'HorizontalAlignment','Left',...
    'String','Function Name');

% Function List Box
fm.lh2 = uicontrol('Style',   'ListBox',...
    'String',functionList,...
    'CallBack', '',...
    'Enable','on',...
    'Callback',['mpt_fm_callback(''fun_select'',''','',''')'],...
    'Position',[fm.bx+fm.w1,fm.by,fm.w2,fm.lh]);
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
fm.frmfnh = uicontrol('Style','frame','Position',[fm.bx+fm.w1+fm.w2+fm.m,fm.lh-4*fm.hm-6,fm.w3+fm.w4+5*fm.m,5*fm.h+6],...
    'Tag','mpm_dialog','ForegroundColor','white');
fm.intth = uicontrol('Style','Text',...
    'String','Internal Prototype Header File Naming',...
    'HorizontalAlignment','Left',...
    'Visible','on',...
    'Position',[fm.bx+fm.w1+fm.w2+3*fm.m,fm.lh+0*fm.hm,fm.w3+60,fm.h]);
miscOptions = get_misc_options(modelName);
value = get_Internal_Approach_Value(miscOptions.InternalApproach);
fm.intth2 =     uicontrol('Style','Text',...
    'Position',[fm.bx+fm.w1+fm.w2+3*fm.m,fm.lh-1*fm.hm,fm.w3+75,fm.h],...
    'HorizontalAlignment','Left',...
    'String','Approach:',...
    'Tag','mpm_dialog');
fm.intpuh = uicontrol('Style','popupmenu',...
    'Position',[fm.bx+fm.w1+fm.w2+3*fm.m+55,fm.lh-1*fm.hm+3,fm.w3+92,fm.h],...
    'String',...
    { 'Direct prototype inclusion',...
        'Single Internal Prototype Header File',...
        'Individual Internal Prototype Header Files'},...
    'BackGroundColor','white', ...
    'Value',value,...
    'Callback',['mpt_fm_callback(''InternalApproach'',''','',''')'],...
    'Tag','mpm_dialog');
% fm.intfnth = uicontrol('Style','Text',...
%     'String','steve.c',...
%     'HorizontalAlignment','Left',...
%     'Visible','on',...
%     'Position',[fm.bx+fm.w1+fm.w2+2*fm.m+fm.w3+40,fm.lh-0*fm.hm,fm.w3+40,fm.h]);
fm.fndth = uicontrol('Style','Text',...
    'String','Default Header File Name:',...
    'HorizontalAlignment','Left',...
    'Visible','on',...
    'Position',[fm.bx+fm.w1+fm.w2+2*fm.m,fm.lh-2*fm.hm,fm.w3,fm.h]);
fm.fndeh = uicontrol('Style','Text',...
    'String','',...
    'HorizontalAlignment','Left',...
    'Visible','on',...
    'Enable','on',...
    'Callback',['mpt_fm_callback(''DefaultInternalFileName'',''','',''')'],...
    'Position',[fm.bx+fm.w1+fm.w2+fm.w3+2*fm.m+10,fm.lh-2*fm.hm,fm.w4,fm.h]);
fm.fncbh = uicontrol('Style','checkbox',...
    'String','Override default internal header file name',...
    'Visible','on',...
    'Callback',['mpt_fm_callback(''InternalNameOverride'',''','',''')'],...
    'Position',[fm.bx+fm.w1+fm.w2+2*fm.m,fm.lh-3*fm.hm,fm.w3+90,fm.h],...
    'Value',0);
fm.fnth = uicontrol('Style','Text',...
    'String','Override File Name:',...
    'HorizontalAlignment','Left',...
    'Visible','on',...
    'Position',[fm.bx+fm.w1+fm.w2+2*fm.m+20,fm.lh-4*fm.hm,fm.w3,fm.h]);
fm.fneh = uicontrol('Style','Edit',...
    'String','',...
    'HorizontalAlignment','Left',...
    'Visible','on',...
    'Callback',['mpt_fm_callback(''InternalFileName'',''','',''')'],...
    'BackGroundColor','white', ...
    'Position',[fm.bx+fm.w1+fm.w2+fm.w3+fm.m+10,fm.lh-4*fm.hm,fm.w4,fm.h]);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
fm.frmfnh2 = uicontrol('Style','frame','Position',[fm.bx+fm.w1+fm.w2+fm.m,fm.lh-10*fm.hm-5,fm.w3+fm.w4+5*fm.m,6*fm.h+6],...
    'Tag','mpm_dialog','ForegroundColor','white');
fm.frmfntha = uicontrol('Style','Text',...
    'String','Function Configuration Options',...
    'HorizontalAlignment','Left',...
    'Visible','on',...
    'Position',[fm.bx+fm.w1+fm.w2+3*fm.m,fm.lh-5*fm.hm-7,fm.w3+20,fm.h]);    
fm.fcth = uicontrol('Style','Text',...
    'String','Function Category:',...
    'HorizontalAlignment','Left',...
    'Visible','on',...
    'Position',[fm.bx+fm.w1+fm.w2+2*fm.m,fm.lh-6*fm.hm,fm.w3,fm.h]);
fm.gfth = uicontrol('Style','Text',...
    'String','Graphical Function',...
    'HorizontalAlignment','Left',...
    'Visible','on',...
    'Position',[fm.bx+fm.w1+fm.w2+fm.w3+2*fm.m+10,fm.lh-6*fm.hm,fm.w4,fm.h]);
popupList{1}='Generate Function';
popupList{2}='Replace Function';
fm.puh = uicontrol('Style','Popup',...
    'String',popupList,...
    'Callback',['mpt_fm_callback(''GenReplace'',''','',''')'],...
    'BackGroundColor','white', ...
    'Position',[fm.bx+fm.w1+fm.w2+2*fm.m,fm.lh-7*fm.hm,fm.w3,fm.h]);

fm.cb1h = uicontrol('Style','checkbox',...
    'String','Export From Module',...
    'Position',[fm.bx+fm.w1+fm.w2+2*fm.m,fm.lh-8*fm.hm,fm.w3,fm.h],...
    'Callback',['mpt_fm_callback(''ExportFrom'',''','',''')'],...
    'Visible','on',...
    'Value',0);
fm.cb2 = uicontrol('Style','checkbox',...
    'String','Generate Unique Prototype to Export',...
    'Visible','on',...
    'Callback',['mpt_fm_callback(''GenUnique'',''','',''')'],...
    'Position',[fm.bx+fm.w1+fm.w2+2*fm.m+20,fm.lh-9*fm.hm,fm.w3+90,fm.h],...
    'Value',0);
fm.epth = uicontrol('Style','Text',...
    'String','Exported Proto Header:',...
    'HorizontalAlignment','Left',...
    'Visible','on',...
    'Position',[fm.bx+fm.w1+fm.w2+2*fm.m+20,fm.lh-10*fm.hm,fm.w3,fm.h]);
fm.epeh = uicontrol('Style','Edit',...
    'String','ExportPrototype.h',...
    'HorizontalAlignment','Left',...
    'Visible','on',...
    'Callback',['mpt_fm_callback(''ExportHeader'',''','',''')'],...
    'BackGroundColor','white', ...
    'Position',[fm.bx+fm.w1+fm.w2+fm.w3+fm.m+10,fm.lh-10*fm.hm,fm.w4,fm.h]);

fm.cb3h = uicontrol('Style','checkbox',...
    'String','Replace Function With External Function',...
    'Position',[fm.bx+fm.w1+fm.w2+2*fm.m,fm.lh-11*fm.hm,fm.w3+fm.w4,fm.h],...
    'Value',0);
fm.ept2h =uicontrol('Style','Text',...
    'String','External Proto Header:',...
    'HorizontalAlignment','Left',...
    'Visible','off',...
    'Position',[fm.bx+fm.w1+fm.w2+2*fm.m,fm.lh-8*fm.hm,fm.w3,fm.h]);
fm.epe2h = uicontrol('Style','Edit',...
    'String','HeaderFile.h',...
    'HorizontalAlignment','Left',...
    'Visible','off',...
    'Callback',['mpt_fm_callback(''ReplaceHeader'',''','',''')'],...
    'BackGroundColor','white', ...
    'Position',[fm.bx+fm.w1+fm.w2+fm.w3+fm.m+10,fm.lh-8*fm.hm,fm.w4,fm.h]);

% fm.b1 = uicontrol('Style','PushButton',...
%     'String','Refresh',...
%     'Visible','on',...
%     'Position',[fm.bx+fm.w1+fm.w2+fm.w3+2*fm.m+10,fm.lh-12*fm.hm,fm.w4,fm.h]);
% o=get_param(blockPath,'Object');
% o.UserData=fm;

set(fm.hFig,'UserData',fm);
% s.hFigStr = num2str(fm.hFig);
% s.modelName = modelName;
% set_param(blockPath,'tag',s.hFigStr);
set_param(blockPath,'UserData',fm);
set(mptGUIHandle,'UserData',fm);
mpt_fm_callback('fun_select_base', fm.hFig);
handle = fm.fileFunList{1}.function{1}.handle;
funOption = get_mpt_fun_option(handle);
set(fm.fneh, 'String',funOption.internalFileName);
mpt_fm_callback('RefreshInternal',fm);
% for i=1:length(funOption)
%     if strcmp(funOption{i}.optionStr,'InternalFileName') == 1
%         internalFileName = funOption{i}.valueStr;
%         set(fm.fneh, 'String',internalFileName);
%     end
% end


function value = get_Internal_Approach_Value(inclusionApproach)

switch(inclusionApproach)
    case 'Direct Inclusion'
        value = 1;
    case 'Single Headers'
        value = 2;
    case 'Individual Headers'
        value = 3;
    otherwise
        value = 1;
end